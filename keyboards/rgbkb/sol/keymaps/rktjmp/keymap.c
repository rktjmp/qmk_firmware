#include QMK_KEYBOARD_H

#ifdef PROTOCOL_LUFA
#include "lufa.h"
#include "split_util.h"
#endif

// LAYOUT_kc automatically prepends KC_ to anything given, but not all QMK keys
// are prefixed as such, so make some sneaky maps to fix that.
#define KC_RESET RESET
#define KC_MO MO
#define KC_DF DF
#define KC_RGB_TOG RGB_TOG

enum layer_number {
  _BSE = 0,
  _QWR,
  _CLM,
  _SYM,
  _NAV ,
  _NUM,
};

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
  [_BSE] = LAYOUT_kc(\
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
     GESC   , 1      , 2      , 3      , 4      , 5      , NO     ,  NO     , 6      , 7      , 8      , 9      , 0      , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TAB    , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     LCTL   , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , BSPC   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     LSFT   , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     MO(5)  , LGUI   , LALT   , LGUI   ,MO(_SYM), SPC    , DEL    ,  SPC    , ENT    ,MO(_NAV), NO     , NO     , NO     , NO     ,\
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
                                                  SPC    , DEL    ,  SPC    , ENT    \
 //                                             └────────┴────────┘└────────┴────────┘
  ),
  [_QWR] = LAYOUT_kc(\
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
     TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   ,  TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , Q      , W      , E      , R      , T      , TRNS   ,  TRNS   , Y      , U      , I      , O      , P      , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , A      , S      , D      , F      , G      , TRNS   ,  TRNS   , H      , J      , K      , L      , SCLN   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , Z      , X      , C      , V      , B      , TRNS   ,  TRNS   , N      , M      , COMM   , DOT    , SLSH   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , TRNS   , TRNS   , TRNS   , TRNS ,   TRNS   , TRNS   ,  TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   ,\
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
                                                  TRNS   , TRNS   ,  TRNS   , TRNS   \
 //                                             └────────┴────────┘└────────┴────────┘
  ),
  [_CLM] = LAYOUT_kc(\
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
 //                                             └────────┴────────┘└────────┴────────┘
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
     TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   ,  TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , Q      , W      , F      , P      , B      , TRNS   ,  TRNS   , J      , L      , U      , Y      , SCLN   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , A      , R      , S      , T      , G      , TRNS   ,  TRNS   , M      , N      , E      , I      , O      , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , Z      , X      , C      , D      , V      , TRNS   ,  TRNS   , K      , H      , COMM   , DOT    , SLSH   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS    , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   , TRNS   ,\
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
                                                  TRNS   , TRNS   ,  TRNS   , TRNS   \
 //                                             └────────┴────────┘└────────┴────────┘
  ),
  [_SYM] = LAYOUT_kc(\
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
     TILD   , EXLM   , AT     , HASH   , DLR    , PERC   , NO     ,  NO     , CIRC   , AMPR   , ASTR   , LPRN   , RPRN   , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , LCBR   , RCBR   , LBRC   , RBRC   , BSLS   , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , TILD   , MINS   , PLUS   , EQL    , NO     , NO     , DF(_CLM), NO     , LPRN   , RPRN   , DQUO   , QUOT   , TRNS   ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , NO     , NO     , NO     , NO     , NO     , RESET  , DF(_QWR), NO     , UNDS   , LT     , GT     , PIPE   , RGB_TOG,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , NO     , TRNS   , NO     , TRNS   , TRNS   , TRNS   ,  TRNS   , TRNS   , TRNS   , NO     , NO     , NO     , RGB_MOD,\
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
                                                  TRNS   , TRNS   , TRNS    , TRNS   \
 //                                             └────────┴────────┘└────────┴────────┘
  ),
  [_NAV] = LAYOUT_kc(\
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
     NO     , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , LEFT   , DOWN   , UP     , RGHT   , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , TRNS   , NO     , NO     , NO     , NO     ,\
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
                                                  NO     , NO     ,  NO     , NO     \
 //                                             └────────┴────────┘└────────┴────────┘
  ),
  [_NUM] = LAYOUT_kc(\
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
     NO     , F1     , F2     , F3     , NO     , NO     , NO     ,  NO     , PAST   , P7     , P8     , P9     , PMNS   , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , F4     , F5     , F6     , NO     , NO     , NO     ,  NO     , PSLS   , P4     , P5     , P6     , PPLS   , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , F7     , F8     , F9     , NO     , NO     , NO     ,  NO     , NO     , P1     , P2     , P3     , NO     , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     NO     , F10    , F11    , F12    , NO     , NO     , NO     ,  NO     , NO     , P0     , PDOT   , PENT   , PEQL   , NO     ,\
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
     TRNS   , NO     , NO     , NO     , NO     , NO     , NO     ,  NO     , NO     , NO     , NO     , NO     , NO     , NO     ,\
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
                                                  NO     , NO     ,  NO     , NO     \
 //                                             └────────┴────────┘└────────┴────────┘
 )
};
//
 //┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐┌────────┬────────┬────────┬────────┬────────┬────────┬────────┐
 //├────────┼────────┼────────┼────────┼────────┼────────┼────────┤├────────┼────────┼────────┼────────┼────────┼────────┼────────┤
 //└────────┴────────┴────────┴────────┴────────┤        │        ││        │        ├────────┴────────┴────────┴────────┴────────┘
 //                                             └────────┴────────┘└────────┴────────┘

// Light LEDs 11 & 12 in purple when keyboard layer 2 is active
const rgblight_segment_t PROGMEM mods_layer[] = RGBLIGHT_LAYER_SEGMENTS(
  {0, 6, HSV_PURPLE}
);
// Now define the array of layers. Later layers take precedence
const rgblight_segment_t* const PROGMEM my_rgb_layers[] = RGBLIGHT_LAYERS_LIST(
  mods_layer     // Overrides other layers
);

void keyboard_post_init_user(void) {
  rgblight_disable_noeeprom();
  default_layer_set(1UL << 2); // default to colemak layer
  rgblight_layers = my_rgb_layers;
}

layer_state_t layer_state_set_user(layer_state_t state) {
  // Both layers will light up if both kb layers are active
  rgblight_set_layer_state(0, layer_state_cmp(state, 3));
  return state;
}

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  static uint16_t reset_timer;
  switch (keycode) {
//    case RGBRST:
//#if defined(RGBLIGHT_ENABLE)
//        if (record->event.pressed) {
//          eeconfig_update_rgblight_default();
//          rgblight_enable();
//        }
//#elif defined(RGB_MATRIX_ENABLE)
//        if (record->event.pressed) {
//          eeconfig_update_rgb_matrix_default();
//        }
//#endif
//      return false;
  case RESET:
    // reset only if we hold for half a second
    if (record->event.pressed) {
        reset_timer = timer_read();
    } else {
        if (timer_elapsed(reset_timer) >= 500) {
            reset_keyboard();
        }
    }
    return false;
  }
  return true;
}
